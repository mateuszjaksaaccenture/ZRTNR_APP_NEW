sap.ui.define(["cre/ret/app/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","cre/ret/app/model/formatter","cre/ret/app/model/PopoverMessages","cre/ret/app/model/validation","cre/ret/app/model/ErrProcessor","sap/m/MessageBox","cre/ret/app/model/Utilities"],function(e,t,o,a,s,i,n,r,l){"use strict";return e.extend("cre.ret.app.controller.CreateNoRef",{formatter:a,validation:i,ErrProcessor:n,onInit:function(){var e=new t({enableCreate:false,busy:false,delay:0,docState:sap.ui.core.ValueState.Warning,returnAmount:"0.00",agentPOS:false,enableAccount:false});this._oTable=this.byId("RTRN_ITEMS_TBL");this._oInvoiceInput=this.byId("ifsInvoice");this._oSalesOrderInput=this.byId("ifsSaleOrder");this.getView().setModel(e,"noRefView");this._noRefModel=this.getOwnerComponent().getModel("noRefData");this.getRouter().getRoute("createNoRef").attachPatternMatched(this._onObjectMatched,this);sap.ui.getCore().attachValidationError(function(e){e.getParameter("element").setValueState(sap.ui.core.ValueState.Error)});sap.ui.getCore().attachValidationSuccess(function(e){e.getParameter("element").setValueState(sap.ui.core.ValueState.None)});l.init(this)},onNavBack:function(){var e=o.getInstance().getPreviousHash(),t=sap.ushell.Container.getService("CrossApplicationNavigation");this._beforeNav();if(e!==undefined||!t.isInitialNavigation()){history.go(-1)}else{this.getRouter().navTo("worklist",{},true)}},onPosAdd:function(){if(this._noRefModel.getProperty("/DocToItem")){var e=this._noRefModel.getProperty("/DocToItem");e.push({});this._noRefModel.setProperty("/DocToItem",e)}else{if(!this._noRefModel.getData()){this._noRefModel.setData({})}this._noRefModel.setProperty("/DocToItem",[{}]);this._noRefModel.setProperty("/DocToBapi",[{Id:"",Number:"",Row:0,Field:""}]);this._noRefModel.setProperty("/RtrnToMsg",[{ReturnDoc:""}])}this._validateCreateEnablement()},onMethodPress:function(){var e=this._oTable.getItems(),t=true;for(var o=0;o<e.length;o++){var a=e[o].getCells();for(var s=0;s<a.length;s++){if(i._validatePosition(a[s])===false){t=false}}}if(t===false){var n=!!this.getView().$().closest(".sapUiSizeCompact").length;r.error(this.getResourceBundle().getText("validationError"),{styleClass:n?"sapUiSizeCompact":""});return}var l=this.getView();if(!this._oPmntMethDialog){this._oPmntMethDialog=sap.ui.xmlfragment(l.getId(),"cre.ret.app.view.PaymentMethod",l.getController());this._oPmntMethDialog.addStyleClass(this.getOwnerComponent().getContentDensityClass());l.addDependent(this._oPmntMethDialog)}this._oPmntMethDialog._oDialog.attachEventOnce("afterOpen",function(e){this.getModel("noRefView").setProperty("/busy",true);this._getPmntMethods()}.bind(this));this._oPmntMethDialog.open()},onMessageButtonPressed:function(e){var t=e.getSource();if(!this._oMsgPopover){this._oMsgPopover=sap.ui.xmlfragment("cre.ret.app.view.MessagePopover",this.getView().getController());this._oMsgPopover.addStyleClass(this.getOwnerComponent().getContentDensityClass());t.addDependent(this._oMsgPopover)}this._oMsgPopover.toggle(t)},onNoRefAgentCreate:function(){this.getModel("noRefView").setProperty("/agentPOS",true);this._createNoRefReturn()},onNoRefCreate:function(){this.getModel("noRefView").setProperty("/agentPOS",false);this._createNoRefReturn()},_createNoRefReturn:function(){var e=this._oTable.getItems(),t=this._noRefModel.getProperty("/Zlsch"),o=true;for(var s=0;s<e.length;s++){var l=e[s].getCells();for(var u=0;u<l.length;u++){if(i._validatePosition(l[u])===false){o=false}}}if(t==="P"&&!this._noRefModel.getProperty("/Iban")){r.error(this.getResourceBundle().getText("ibanError"),{styleClass:this._oComponent.getContentDensityClass()});o=false}if(t==="R"||t==="3"){o=i._validateMethodPayment(this.getView());if(o===false){r.error(this.getResourceBundle().getText("pmntMethFieldsVal"),{styleClass:this.getOwnerComponent().getContentDensityClass()})}}if(o===false){return}var g=this._noRefModel.getData(),h=new sap.ui.model.odata.ODataModel(this.getModel().sServiceUrl,false);if(g){g.IsAgentProc=this.getModel("noRefView").getProperty("/agentPOS");var c=this.getModel("appView").getProperty("/Shop"),d=a._fillNoRefDeepData(g,c);this.getModel("noRefView").setProperty("/busy",true)}else{return}h.attachEventOnce("requestSent",function(){sap.ui.getCore().getMessageManager().removeAllMessages()});if(d){h.create("/Documents",d,{async:true,success:function(e,t){this._fnUpdateSuccess(t)}.bind(this),error:function(e){this.getModel("noRefView").setProperty("/busy",false);n.showODataError(e,this.getOwnerComponent())}.bind(this)})}},onPosDelete:function(e){var t=e.getParameter("listItem").getBindingContext("noRefData").getPath(),o=parseInt(t.substring(t.lastIndexOf("/")+1),10),a=this._noRefModel.getData().DocToItem;if(a&&a.length>0){a.splice(o,1)}this._noRefModel.updateBindings();this._validateCreateEnablement()},_getPmntMethods:function(){var e=0,t=this._oTable.getItems();for(var o=0;o<t.length;o++){var a=parseInt(t[o].getBindingContext("noRefData").getObject().PoQuan,10);e=a*(parseFloat(e)+parseFloat(t[o].getBindingContext("noRefData").getObject().BruttoValue)).toFixed(2)}this.getModel("noRefView").setProperty("/toPay",e);this.getModel().callFunction("/GetReturnMethod",{method:"GET",urlParameters:{GrossVal:e},async:true,success:function(e){this.getOwnerComponent().getModel("pmntMethods").setData(e);this.getModel("noRefView").setProperty("/busy",false)}.bind(this),error:function(e){var t=JSON.parse(e.response.body).error.message.value;r.error(t);this.getModel("noRefView").setProperty("/busy",false)}.bind(this)})},_handlePmntMethConfirm:function(e){var t=e.getParameter("selectedItem").getDescription(),o=true;if(t==="W"){this._noRefModel.setProperty("/Iban","");o=this._checkMoneyAvailable(this.getModel("noRefView").getProperty("/toPay"),this.getOwnerComponent().getModel("pmntMethods").getData(),t)}else if(t==="P"){o=false;this.callIbanField()}else{this._noRefModel.setProperty("/Iban","")}if(o){this._setPaymentMethod(t)}},_setPaymentMethod:function(e){var t=this._oTable.getItems();this._noRefModel.setProperty("/Zlsch",e);for(var o=0;o<t.length;o++){var a=t[o].getBindingContext("noRefData").getPath();this._noRefModel.setProperty(a+"/Zlsch",e)}this._validateCreateEnablement()},_checkMoneyAvailable:function(e,t,o){var a=parseFloat(e),s,i,n=function(e){if(e.Key==="E"){return e}},u=function(e){if(e.Key==="M"){return e}};var g=t.results.find(u);var h=t.results.find(n);if(g&&h){s=parseFloat(g.Value);i=parseFloat(h.Value);if(a>s||s>a&&s-a<i){var c;if(a>s){c=this.getResourceBundle().getText("noCashNoRef",[s])}else{c=this.getResourceBundle().getText("lowCashLevelNoRef",[s,i])}var d=function(e){this._setPaymentMethod(e)}.bind(this);var f=function(){this.onMethodPress()}.bind(this);l.lowCashLevelWarningNoRef(c,f,d,o);return false}else{return true}}else{var p=!!this.getView().$().closest(".sapUiSizeCompact").length;r.error(this.getResourceBundle().getText("couldntReadMoney"),{styleClass:p?"sapUiSizeCompact":""});return false}},callIbanField:function(){if(!this._oIBANDialog){this._oIBANDialog=sap.ui.xmlfragment("cre.ret.app.view.AccountData",this);this.getView().addDependent(this._oIBANDialog);$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oIBANDialog)}this._oIBANDialog.open()},_validateAccountData:function(e){this.getModel("noRefView").setProperty("/enableAccount",this._validIban(e))},_validateMainIban:function(e){this.getModel("noRefView").setProperty("/enableCreate",this._validIban(e))},_validIban:function(e){var t=e.getParameters().newValue,o=false;if(t){o=i.validateIBAN(t);o?e.getSource().setValueState(sap.ui.core.ValueState.None):e.getSource().setValueState(sap.ui.core.ValueState.Error)}return o},onAccountSubmit:function(){this._setPaymentMethod("P");this.onIbanClose()},onIbanClose:function(){if(this._oIBANDialog.isOpen()){this._oIBANDialog.close()}},_fnUpdateSuccess:function(e){var t;if(e.data.hasOwnProperty("RtrnToMsg")&&e.data.RtrnToMsg.results!==undefined&&e.data.RtrnToMsg.results.length>0){var o=e.data.RtrnToMsg.results[0].ReturnDoc,a=e.data.RtrnToMsg.results[0].PaymntMeth,i=e.data.RtrnToMsg.results[0].Znus;if(a==="X"){t=this.getResourceBundle().getText("SCS_RT_MSG",[o,this.getResourceBundle().getText("SCS_RT_MSG_PAY_METH_1")])}else{t=this.getResourceBundle().getText("SCS_RT_MSG",[o,this.getResourceBundle().getText("SCS_RT_MSG_PAY_METH_2")])}if(i&&i.length>0){t=this.getResourceBundle().getText("SCS_RT_MSG_NOTE_ZNUS",[o,i])}}else{t=this.getResourceBundle().getText("SCS_RT_MSG_NO_DATA")}if(e.data.hasOwnProperty("DocToBapi")&&e.data.DocToBapi.results!==undefined&&e.data.DocToBapi.results.length>0){s._addMessageFromData(e.data.DocToBapi.results)}r.success(t,{id:"successReturnMessageBox",styleClass:this.getOwnerComponent().getContentDensityClass(),actions:[this.getResourceBundle().getText("close")],onClose:function(e){this.onNavBack()}.bind(this)});this._finishAction()},_beforeNav:function(){this._noRefModel.setData()},_finishAction:function(){this.getModel("noRefView").setProperty("/busy",false)},_onObjectMatched:function(e){this._noRefModel.setProperty("/Country","PL");this.getModel("noRefView").setProperty("/agentPOS",false);if(sap.ui.getCore().getMessageManager().getMessageModel().getData().length>0){sap.ui.getCore().getMessageManager().removeAllMessages()}},_countryHelpRequest:function(e){var t=e.getSource();if(!this._oCountryDialog){this._oCountryDialog=sap.ui.xmlfragment("cre.ret.app.view.Country",this);this._oCountryDialog.setModel(this.getView().getModel())}this._oCountryDialog.getBinding("items").filter([]);this._oCountryDialog.attachEventOnce("confirm",function(e){var o=e.getParameter("selectedItem").getDescription();t.setValue(o)});jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oCountryDialog);this._oCountryDialog.open()},_productHelpRequest:function(e){var t=e.getSource(),o=t.getParent().getBindingContext("noRefData").getPath();if(!this._oProductDialog){this._oProductDialog=sap.ui.xmlfragment("cre.ret.app.view.Products",this);this._oProductDialog.setModel(this.getView().getModel())}this._oProductDialog.getBinding("items").filter([]);this._oProductDialog.attachEventOnce("confirm",function(e){var a=e.getParameter("selectedItem").getDescription();this.getModel("noRefData").setProperty(o+"/Material",a);t.setValueState(sap.ui.core.ValueState.None)}.bind(this));jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oProductDialog);this._oProductDialog.open()},_snChange:function(e){if(e.getParameter("value")){var t=e.getSource().getParent().getBindingContext("noRefData").getPath();this.getModel("noRefData").setProperty(t+"/PoQuan",1);return}},_quanLive:function(e){if(e.getParameter("value")){e.getSource().setValueState(sap.ui.core.ValueState.None)}else{e.getSource().setValueState(sap.ui.core.ValueState.Error)}},_comboChange:function(e){if(e.getParameter("selectedItem").getKey()){e.getSource().setValueState(sap.ui.core.ValueState.None)}},_checkItemsAvailable:function(){return this._oTable.getItems().length>0?true:false},_validateCreateEnablement:function(){var e=this.formatter._getFromFields(this.byId("CUST_DATA_FORM"));var t=this._validateDocNumbers(),o;for(var a=0;a<e.length;a++){o=e[a].control;if(e[a].required){var s=o.getValue();if(!s){this.getModel("noRefView").setProperty("/enableCreate",false);return}}}if((t&&this._checkItemsAvailable()&&this._zipCodeIsValid())===true){var n=true;if(this._noRefModel.getProperty("/Zlsch")==="P"){n=i.validateIBAN(this._noRefModel.getProperty("/Iban"))}this.getModel("noRefView").setProperty("/enableCreate",n)}else{this.getModel("noRefView").setProperty("/enableCreate",false)}},_validateDocNumbers:function(){var e=this._oInvoiceInput.getValue(),t=this._oSalesOrderInput.getValue();if(e||t){this.getModel("noRefView").setProperty("/docState",sap.ui.core.ValueState.None);return true}else{this.getModel("noRefView").setProperty("/docState",sap.ui.core.ValueState.Warning);return false}},zipCodeChange:function(e){this._validateCreateEnablement();this._zipCodeIsValid()},_zipCodeIsValid:function(){var e=true,t=this.byId("zipCode"),o=t._oTempValue._aContent,a=t._oTempValue._aInitial,s=/^\d+$/;e=o.every(function(e,t){if(t!==2&&!s.test(e)){return false}return true},this);if(e){t.setValueState(sap.ui.core.ValueState.None)}else{t.setValueState(sap.ui.core.ValueState.Warning)}return e},_handleCountrySearch:function(e){var t=e.getParameter("value"),o=[],a;if(t){a=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();o.push(new sap.ui.model.Filter("Landx",sap.ui.model.FilterOperator.StartsWith,a))}var s=e.getSource().getBinding("items");s.filter(o)},_handleProductSearch:function(e){var t=e.getParameter("value"),o=[];if(t){var a=t.toUpperCase();o.push(new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.StartsWith,a))}var s=e.getSource().getBinding("items");s.filter(o)}})});
//# sourceMappingURL=CreateNoRef.controller.js.map