sap.ui.define(["cre/ret/app/controller/BaseController","sap/ui/model/json/JSONModel","cre/ret/app/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/routing/History","sap/m/MessageBox","cre/ret/app/model/ErrProcessor"],function(e,t,o,s,r,i,a,n){"use strict";const l=3;const h=2;const g=1;const c=0;return e.extend("cre.ret.app.controller.Worklist",{formatter:o,ErrProcessor:n,onInit:function(){var e,o,s=this.byId("DOC_LIST");o=s.getBusyIndicatorDelay();this._oTable=s;this._oDocTypeList=this.byId("SELECT_SEARCH");this._oTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0,nipVisible:false,snVisible:true,invVisible:true,prodVisible:true,srchMaxLength:0,searchResultAmount:0});this.setModel(e,"worklistView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));s.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",o)})},onUpdateFinished:function(e){var t,o=e.getSource(),s=e.getParameter("total");if(s&&o.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[s])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getModel("worklistView").setProperty("/searchResultAmount",s);this.getModel("worklistView").setProperty("/worklistTableTitle",t);this._checkReturnStatus(o)},onItemPress:function(e){this._showObject(e.getSource())},onNavBack:function(){var e=i.getInstance().getPreviousHash(),t=sap.ushell.Container.getService("CrossApplicationNavigation");if(e!==undefined||!t.isInitialNavigation()){history.go(-1)}else{t.toExternal({target:{shellHash:"#Shell-home"}})}},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=e.getParameter("query"),o=this._oDocTypeList.getSelectedItem().getKey();t=t.replace(/\s/g,"");if(o==="VBELN_VA"||o==="VBELN_VF"){if(t.length>10){a.warning(this.getResourceBundle().getText("verifyDocLength"),{styleClass:this.getOwnerComponent().getContentDensityClass()});return}}this._createFilter(t)}},onShopSelect:function(){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("cre.ret.app.view.SelectShop",this);this.getView().addDependent(this._oDialog);$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oDialog)}this._oDialog.open()},onSearchPressed:function(){var e=this.byId("SEARCH_FIELD").getValue(),t=this._oDocTypeList.getSelectedItem().getKey();if(t==="VBELN_VA"||t==="VBELN_VF"){if(e.length>10){a.warning(this.getResourceBundle().getText("verifyDocLength"),{styleClass:this.getOwnerComponent().getContentDensityClass()});return}}this._createFilter(e)},onDocTypeChange:function(e){var t=e.getParameter("selectedItem").getKey();switch(t){case"STCD1":o.docTypeChange(this.getModel("worklistView"),t);break;case"ZXXSER50":o.docTypeChange(this.getModel("worklistView"),t);this._oTable.rerender();return;case"VBELN_VA":o.docTypeChange(this.getModel("worklistView"),t);default:o.docTypeChange(this.getModel("worklistView"),t)}this._oTable.rerender()},onCloseSelectShop:function(){this._oDialog.close()},onNoRefCreate:function(){this.getRouter().navTo("createNoRef")},onRefresh:function(){this._oTable.getBinding("items").refresh()},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("Invoice")})},_createFilter:function(e){var t=[];var o=this.byId("SELECT_SEARCH").getSelectedItem().getKey();if(e&&e.length>0){var i=o==="VBELN_VA"||o==="VBELN_VF"||o==="NRKSEF"?r.EQ:r.Contains;t=[new s("SrchString",i,e),new s("DocType",r.EQ,o)]}this._applySearch(t)},_onMetadataLoaded:function(){var e=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZRETURN_CREA_SRV");var t="/IFSAuthSet";e.read(t,{async:true,success:function(e){for(var t=0;t<=e.results.length-1;t++){if(e.results[t].AUTH_NAME==="IFSAuth"&&e.results[0].IS_AUTH===""){sap.ui.getCore().byId("application-ZRTRN-create-component---worklist--createNoRef-button").setVisible(false)}}},error:function(e){console.log(e)}});var e=this.getOwnerComponent().getModel("CheckOut"),o=this.getResourceBundle().getText("errorBSCS");e.setSizeLimit(1e3);e.read("/UserDefaultsSet(Name='')",{success:function(t,s){this.getModel("appView").setProperty("/Shop",s.data.Shop);var r="/ShopSet('"+s.data.Shop+"')";e.read(r,{async:true,success:function(e,t){if(t.data.Blocked){this._handleBlockedShop();this.getModel("appView").setProperty("/ShopAvailable",false);sap.m.MessageBox.error(sMsg)}else{this.getModel("appView").setProperty("/ShopAvailable",true);if(t.data.Salid){this.getModel("appView").setProperty("/Salid",t.data.Salid)}else{this.getModel("appView").setProperty("/Salid",o);sap.m.MessageBox.show(o)}}}.bind(this),error:function(e){sap.m.MessageBox.show("Error: "+e)}})}.bind(this),error:function(e){n.showODataError(e,this.getOwnerComponent())}.bind(this)})},_handleSaveShop:function(e){var t=e.getSource().getParent().getContent()[0].getSelectedItem().getBindingContextPath(),o=this.getView().getModel("CheckOut"),s=o.getData(t),r=this.getResourceBundle().getText("errorBSCS");if(s.Selected!==true){s.Selected=true;o.update(t,s,{async:false,success:function(e,t){var o=t.headers.shop,s=t.headers.blocked==="X",r=this.getResourceBundle().getText("ShopSaved",[o]);if(s){this.getModel("appView").setProperty("/Shop",o);sap.m.MessageToast.show(r);this._handleBlockedShop()}else{this.getModel("appView").setProperty("/ShopAvailable",true);this.getModel("appView").setProperty("/Shop",o);this.getModel("appView").setProperty("/Salid",t.headers.bscs);sap.m.MessageToast.show(r)}}.bind(this),error:function(e){this.getModel("appView").setProperty("/Salid",r);n.showODataError(e,this.getOwnerComponent())}.bind(this)})}this._oDialog.close()},_applySearch:function(e){var t=this.getModel("worklistView");this.getOwnerComponent().getModel().attachEventOnce("requestFailed",function(e){try{var t=JSON.parse(e.getParameter("response").responseText).error.message.value;a.error(t)}catch{}});this._oTable.getBinding("items").filter(e,"Application");if(e.length!==0){t.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},_handleBlockedShop:function(){var e=this.getResourceBundle().getText("ShopBlocked");this.getModel("appView").setProperty("/ShopAvailable",false);sap.m.MessageBox.error(e)},_checkReturnStatus:function(e){e.getItems().forEach(function(e){var t=e.getBindingContext();if(t.getProperty("ReturnStatus")===l){if(t.getProperty("SalesDoc")==="BRAK REFERENCJI"){a.warning(this.getResourceBundle().getText("ORDER_RETURN_OPENED_NS",[t.getProperty("SerialNums"),t.getProperty("OpenReturnDoc")]))}else{a.warning(this.getResourceBundle().getText("ORDER_RETURN_OPENED",[t.getProperty("SalesDoc"),t.getProperty("OpenReturnDoc")]))}}else if(t.getProperty("ReturnStatus")===h){if(t.getProperty("SalesDoc")==="BRAK REFERENCJI"){a.warning(this.getResourceBundle().getText("ORDER_FULLY_RETURNED_NS",[t.getProperty("SerialNums")]))}else{a.warning(this.getResourceBundle().getText("ORDER_FULLY_RETURNED",[t.getProperty("SalesDoc")]))}}else if(t.getProperty("ReturnStatus")===g){a.warning(this.getResourceBundle().getText("ORDER_PARTIALLY_RETURNED",[t.getProperty("SalesDoc")]))}}.bind(this))}})});
//# sourceMappingURL=Worklist.controller.js.map