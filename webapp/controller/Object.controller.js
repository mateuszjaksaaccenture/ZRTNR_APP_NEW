sap.ui.define(["cre/ret/app/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","cre/ret/app/model/formatter","cre/ret/app/model/validation","cre/ret/app/model/PopoverMessages","sap/m/MessageBox","sap/m/MessageToast","cre/ret/app/model/ErrProcessor","cre/ret/app/model/Utilities","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,i,s,a,o,r,n,l,g,d,h){"use strict";const u=0;const c=1;const p=2;const m=3;const f=4;const _=5;const P=6;return e.extend("cre.ret.app.controller.Object",{formatter:s,validation:a,PopoverMessage:o,ErrProcessor:l,Utilities:g,_oBinding:{},_mainPmntProc:"MAIN",_dispPmntProc:"DISP",onInit:function(){g.init(this);this._markedTable=[];this._checkedTable=[];this._justSelected;this._justSelectedNS;var e,t=g.creeateObjectViewModel(true);this._oLineTable=this.byId("PROD_TBL");this._oLineTable._getSelectAllCheckbox().setVisible(false);this._oAddTable=this.byId("ADD_PROD_TBL");this._oModel=this.getOwnerComponent().getModel();this._oViewModel=t;this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);e=this.getView().getBusyIndicatorDelay();this.setModel(t,"objectView");this._oModel.metadataLoaded().then(function(){t.setProperty("/delay",e)});sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);var i=sap.ui.getCore().getMessageManager().getMessageModel();this._oBinding=new sap.ui.model.Binding(i,"/",i.getContext("/"))},onNavBack:function(){var e=i.getInstance().getPreviousHash(),t=sap.ushell.Container.getService("CrossApplicationNavigation");this._beforeNav();this.cleanup();if(e!==undefined||!t.isInitialNavigation()){this.getRouter().navTo("worklist",{},true)}else{this.getRouter().navTo("worklist",{},true)}},onPosAdd:function(e){var t=this.getModel("addData"),i=t.getData(),a;if(!i.addItems){i.addItems=[];a=s._generateItmNumber(1)}else{a=s._generateItmNumber(i.addItems.length+1)}i.addItems.push({ItmNumber:a,PoQuan:"1.000"});t.setData(i);this._oViewModel.setProperty("/addItems",i.addItems.length)},onDispPrint:function(e){var t=this._oViewModel,i;this._customerData=e.getSource().getParent().getContent()[0].getModel("customer").getData();var a=this._checkCustomerData(this._customerData);if(a===false){return}var o=function(e,i){if(e.Guid){t.setProperty("/guid",e.Guid);this._printDispo(e.Guid)}t.setProperty("/busy",false)}.bind(this);var r=function(e){t.setProperty("/busy",false);l.showODataError(e,this.getOwnerComponent())}.bind(this);this.oHeaderData=this.aDocToItems=undefined;this._getSelectedData();if(this.aDocToItems){t.setProperty("/busy",true);i=s._fillDeepDispoPrint(t.getProperty("/guid"),this.oHeaderData,this.aDocToItems);g.createDispoPrintEntry(i,o,r)}},_printDispo:function(e){var t=function(e){window.open(e);this._oViewModel.setProperty("/dispoPrint",true);this._validateSubmitEnablement()}.bind(this);var i=function(e){this._oViewModel.setProperty("/dispoPrint",true);this._validateSubmitEnablement();l.showODataError(e,this.getOwnerComponent())}.bind(this);g.printDisposition(e,t,i)},onGetSNDialog:function(e){this.oAddSNInput=e.getSource();this.snAddPath=this.oAddSNInput.getBindingContext("addData").getPath();this.instQuan=this._getItemProperty("InstQuantity");this.Invoice=this._getItemProperty("Invoice");this.ItmNumber=e.getSource().getBindingContext("addData").getObject("ItmNumber");this.Zzbillacc=this._getItemProperty("Zzbillacc");if(!this._oSNDialog){this._oSNDialog=sap.ui.xmlfragment("cre.ret.app.view.SerialNumber",this);this.getView().addDependent(this._oSNDialog)}this._oSNDialog.open()},onConfirmSN:function(e){this._oViewModel.setProperty("/busy",true);this._getProductBySerial(this._oViewModel.getProperty("/additionalSN"))},onCancelSN:function(){this._oViewModel.setProperty("/snValueState",sap.ui.core.ValueState.None);this._oViewModel.setProperty("/additionalSN","");this._oSNDialog.close()},onAddProdDelete:function(e){var t=e.getParameter("listItem").getBindingContext("addData").getPath(),i=parseInt(t.substring(t.lastIndexOf("/")+1),10),a=this.getModel("addData").getData().addItems;if(a&&a.length>0){a.splice(i,1)}this._oViewModel.setProperty("/addItems",a.length);this.getModel("addData").updateBindings();this._oViewModel.setProperty("/addReturnAmount",s._calculateAddPrice(this._oAddTable.getItems()))},onUpdateFinished:function(e){var t,i=e.getSource(),s=e.getParameter("total");if(s&&i.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("PROD_HEADER_COUNT",[s])}else{t=this.getResourceBundle().getText("PROD_HEADER")}this._oViewModel.setProperty("/lineItemsTableHeader",t);this._setTableLinesUnenabled(i)},onMethodPress:function(){var e=this.getView();if(a._validateCombo(this._oLineTable.getSelectedItems())===false){var t=!!e.$().closest(".sapUiSizeCompact").length;r.error(this.getResourceBundle().getText("validationError"),{styleClass:t?"sapUiSizeCompact":""});return}if(this._oViewModel.getProperty("/addItems")>0){if(a._validateCombo(this._oAddTable.getItems())===false){var t=!!e.$().closest(".sapUiSizeCompact").length;r.error(this.getResourceBundle().getText("validationError"),{styleClass:t?"sapUiSizeCompact":""});return}}if(!this.getModel("addData").getProperty("/RetReason")){var t=!!e.$().closest(".sapUiSizeCompact").length;r.error(this.getResourceBundle().getText("validationError"),{styleClass:t?"sapUiSizeCompact":""});return}if(this.getModel().getProperty(e.getBindingContext().getPath()+"/InvoiceIsExt")){if(a._validateIfsSet(this._oLineTable.getSelectedItems(),this.getModel("addData").getData().addItems,this)===false){return}else{this._getPmntMethods()}}else{this._getPmntMethods()}},_getPmntMethods:function(e){var t=this._oViewModel,i=this.getModel("pmntMethods"),a=this.getModel("dsipPmntMethods"),o;var r=function(e){s.setDataFromPaymentRequest(e,t,i,a);if(t.getProperty("/ownPayment")>0&&e.Key===this._dispPmntProc){t.setProperty("/pmntDialogTitle",this.getResourceBundle().getText("SelectPmntMethDisp"));this._openDispPmntDialog()}else{if(t.getProperty("/noAccountDoc")){var o=function(e){this._handlePmntMethConfirm(null,true,e)}.bind(this);g.noAccountDocWarning(o);return}if(t.getProperty("/ownPayment")==0&&t.getProperty("/disposition")){t.setProperty("/pmntDialogTitle",this.getResourceBundle().getText("SelectPmntMethDisp"))}else if(t.getProperty("/disposition")){t.setProperty("/pmntDialogTitle",this.getResourceBundle().getText("SelectPmntMethOwnPay"))}else{t.setProperty("/pmntDialogTitle",this.getResourceBundle().getText("SelectPmntMeth"))}this._openPmntDialog()}}.bind(this);var n=function(e){t.setProperty("/busy",false);l.showODataError(e,this.getOwnerComponent())}.bind(this);this.oHeaderData=this.aDocToItems=undefined;if(a.getData().hasOwnProperty("results")&&e===this._mainPmntProc){o=a.getData().results}this._getSelectedData();if(this.aDocToItems||o){var d=s._fillDeepDataForPmnts(this.aDocToItems,o,t.getProperty("/dispMethod"));t.setProperty("/busy",true);t.setProperty("/dispoPrint",false);g.readPaymentMethods(d,r,n)}},_handleDispMethConfirm:function(e){var t=e.getParameter("selectedItem").getDescription(),i=this._oViewModel;i.setProperty("/dispMethod",t);this._getPmntMethods(this._mainPmntProc)},_handlePmntMethConfirm:function(e,t,i){var s=t?i:e.getParameter("selectedItem").getDescription(),a=this.getView().getBindingContext(),o=a.getProperty("FirstPayment"),r=this._oLineTable.getSelectedItems(),n=this._oViewModel,l=[],d=parseFloat(n.getProperty("/returnAmount"))+parseFloat(n.getProperty("/addReturnAmount")),h=n.getProperty("/ownPayment")?parseFloat(n.getProperty("/ownPayment")):0,u=n.getProperty("/shopBalance"),c=n.getProperty("/emergencyFund");this.getModel("addData").setProperty("/Zlsch",s);if(s==="P"||s==="R"){n.setProperty("/disposition",true)}n.setProperty("/zlsch",s);var p=function(){this._getPmntMethods(this._mainPmntProc)}.bind(this);var m=function(e){this._handlePmntMethConfirm(null,true,e)}.bind(this);var f,_;if(n.getProperty("/disposition")===true){n.setProperty("/enableSubmit",false);if(!n.getProperty("/dispMethod")){n.setProperty("/dispMethod",s)}n.setProperty("/dispoItemZlsch",s);if(s==="W"&&(h>u||u>h&&u-h<c)){_=h>u?"noCash":"lowCashLevel";_==="lowCashLevel"?l.push(u,c):l.push(u)}}else{if(s==="W"&&(d>u||u>d&&u-d<c)){_=d>u?"noCashNoRef":"lowCashLevelNoRef";_==="lowCashLevelNoRef"?l.push(u,c):l.push(u)}}f=_?this.getResourceBundle().getText(_,l):"";if(_&&!t){g.lowCashLevelWarning(f,p,m,s);return}for(var P=0;P<r.length;P++){var y=r[P].getBindingContext().getPath(),D=this.getModel("addData").getProperty(y);this.getModel().setProperty(y+"/Zlsch",s,null,true);if(!D){D={Zlsch:s}}else{D.Zlsch=s}this.getModel("addData").setProperty(y,D);if(D.RetReason){this._oLineTable.getSelectedItems()[P].getCells()[4].setSelectedKey(D.RetReason)}}this.getModel().setProperty(a.getPath()+"/Zlsch",s);this.getModel().setProperty(a.getPath()+"/IsDisposition",n.getProperty("/disposition"));var b=this.getModel("addData").getData().addItems;if(b&&b.length>0){for(var M=0;M<b.length;M++){b[M].Zlsch=s}this.getModel("addData").updateBindings()}this.returnCreate(a)},_openPmntDialog:function(){if(!this._oPmntMethDialog){this._oPmntMethDialog=this._createDialog(this._oPmntMethDialog,"cre.ret.app.view.PaymentMethod")}this._oPmntMethDialog.open()},_openDispPmntDialog:function(){if(!this._oDispPmntMethDialog){this._oDispPmntMethDialog=this._createDialog(this._oDispPmntMethDialog,"cre.ret.app.view.DispPaymentMethod")}this._oDispPmntMethDialog.open()},_createDialog:function(e,t){var i=this.getView();e=sap.ui.xmlfragment(i.getId(),t,i.getController());e.addStyleClass(this.getOwnerComponent().getContentDensityClass());i.addDependent(e);$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),i,e);return e},returnCreate:function(e){var t=e.getObject(),i=t.CustNum,s=t.Taxnumber1,a=t.InvoiceIsExt,o=this._oViewModel.getProperty("/zlsch"),r=this._oViewModel.getProperty("/dispoItemZlsch");this._callCreateCustomerData()},_getProductBySerial:function(e){if(!this._checkSNisNotExist(e)){this._oViewModel.setProperty("/busy",false);return}if(e){this.getModel().callFunction("/GetSerialProduct",{method:"GET",urlParameters:{Serialno:e},async:true,success:function(e){if(!e.Zzbillacc||e.Zzbillacc!=this.Zzbillacc||e.InstQuantity!=this.instQuan||e.Invoice!=this.Invoice){this._oViewModel.setProperty("/snValueState",sap.ui.core.ValueState.Error);r.error(this.getResourceBundle().getText("billingKontoError"))}else{e.ItmNumber=this.ItmNumber;e.AppQty="1";this.getModel("addData").setProperty(this.snAddPath,e);this._oViewModel.setProperty("/snValueState",sap.ui.core.ValueState.None);this._oViewModel.setProperty("/additionalSN","");this.oAddSNInput.setValueState(sap.ui.core.ValueState.None);this._oSNDialog.close()}this._oViewModel.setProperty("/addReturnAmount",s._calculateAddPrice(this._oAddTable.getItems()));this._oViewModel.setProperty("/busy",false)}.bind(this),error:function(e){this._oViewModel.setProperty("/busy",false);l.showODataError(e,this.getOwnerComponent())}.bind(this)})}else{r.error(this.getResourceBundle().getText("emptySernNr"));this._oViewModel.setProperty("/snValueState",sap.ui.core.ValueState.Error)}this._oViewModel.setProperty("/busy",false)},_checkSNisNotExist:function(e){var t=this._oAddTable.getItems();for(var i=0;i<t.length;i++){if(t[i].getBindingContext("addData").getObject().Serialno===e){this._oViewModel.setProperty("/snValueState",sap.ui.core.ValueState.Error);r.error(this.getResourceBundle().getText("snAlreadyExist",[e]));return false}}if(this._getItemProperty("Serialno")===e){this._oViewModel.setProperty("/snValueState",sap.ui.core.ValueState.Error);r.error(this.getResourceBundle().getText("snAlreadyExist",[e]));return false}return true},_getItemProperty:function(e){var t=this._oLineTable.getItems();for(var i=0;t.length;i++){if(t[i].getMetadata().getName()==="sap.m.ColumnListItem"){return t[i].getBindingContext().getObject(e)}}},checkReturnPossible:function(){var e=this.byId("PROD_TBL");var t=e.getItems();var i=0,s=false,a,o;for(var r=0;r<t.length;r++){if(t[r].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){if(t[r].getSelected()===true){s=true;o=t[r].getBindingContext().getObject();if(!o.ParentMaterial){a=parseInt(o.AppQty,10);i=parseFloat(i)+a*(parseFloat(o.BruttoValue)/parseFloat(o.AppQty))}}}}if(s){this._oViewModel.setProperty("/createEnable",s);this._oViewModel.setProperty("/returnAmount",parseFloat(i));return}else{this._oViewModel.setProperty("/returnAmount",parseFloat(0));this._oViewModel.setProperty("/createEnable",s)}},onCustomerSubmit:function(e){this._customerData=e.getSource().getParent().getContent()[0].getModel("customer").getData();var t=this._checkCustomerData(this._customerData);if(t===false){return}this._callCreateReturnFunction()},onCloseDialog:function(){this._oCustDialog.close()},onScanerAction:function(e){this._selectItemFromScaner(e)},onRowSelected:function(e){var t=this.byId("PROD_TBL");var i=t.getItems();var s=e.getParameter("listItem").getBindingContext().getObject().ParentMaterial;var a=e.getParameter("listItem").getBindingContext().getObject().Invoice;var o=e.getParameter("listItem").getBindingContext().getObject().Material;var n=e.getParameter("listItem").getBindingContext().getObject().RefItmNumber;var l=e.getParameter("listItem").getBindingContext().getObject().SalesDoc;var g=e.getParameter("listItem").getBindingContext().getObject().Serialno;var d=e.getParameter("listItem").getBindingContext().getObject().ReturNotAllowedZfdate;var h;for(var u=0;u<i.length;u++){if(i[u].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var c=i[u].getBindingContext().getObject();if(c.ParentMaterial===s&&c.RefItmNumber===n&&c.Material===o&&c.Serialno===g){var p=u;this._justSelected=i[u];this._justSelectedNS=g;var m=i[u].getSelected()}else{continue}}}var f=false;for(var u=0;u<i.length;u++){if(i[u].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var c=i[u].getBindingContext().getObject();if(c.ParentMaterial===o&&c.RefItmNumber===n){var _=true}}}if(m&&d==="X"){r.error(this.getResourceBundle().getText("unableReturnZfdate"),{styleClass:this.getOwnerComponent().getContentDensityClass()});for(var u=0;u<i.length;u++){if(i[u].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var c=i[u].getBindingContext().getObject();if(c.ParentMaterial===s&&c.RefItmNumber===n&&c.Material===o&&c.Serialno===g){i[u].setSelected(false)}}}}else if(m&&_===true){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("cre.ret.app.view.Dialog",this);this.getView().addDependent(this._oDialog);$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oDialog)}this.onDialogDisplay(a,o,n,l,g);this._oDialog.open();if(document.querySelector("#DialogID-ok-content")){var P=this.getView().getModel("i18n").getResourceBundle().getText("confirmButton");document.querySelector("#DialogID-ok-content").textContent=P;$("#DialogID-ok-content").css("font-size","10px")}sap.ui.core.BusyIndicator.show(0)}else if(!m&&_===true){for(var u=0;u<i.length;u++){if(i[u].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var c=i[u].getBindingContext().getObject();var y=i[u].getBindingContext().sPath;if(c.ParentMaterial===o&&c.RefItmNumber===n){if(g){for(var D=0;D<this._checkedTable.length;D++){if(c.ParentMaterial===this._checkedTable[D].ParentMaterial&&c.Material===this._checkedTable[D].Material&&c.RefItmNumber===this._checkedTable[D].RefItmNumber&&g===this._checkedTable[D].Serialno&&this._checkedTable[D].Serialno===c.Serialno){if(parseInt(c.AppQty)===1){h="0";i[u].getBindingContext().getModel().setProperty(y+"/AppQty",h);i[u].setSelected(false);this._checkedTable.splice(D,1)}else if(parseInt(c.AppQty)>1){h=(parseInt(c.AppQty)-1).toString();i[u].getBindingContext().getModel().setProperty(y+"/AppQty",h);this._checkedTable.splice(D,1)}}}}else{for(var D=0;D<this._checkedTable.length;D++){if(c.ParentMaterial===this._checkedTable[D].ParentMaterial&&c.Material===this._checkedTable[D].Material&&c.RefItmNumber===this._checkedTable[D].RefItmNumber){if(parseInt(c.AppQty)===1){h="0";i[u].getBindingContext().getModel().setProperty(y+"/AppQty",h);i[u].setSelected(false);this._checkedTable.splice(D,1)}else if(parseInt(c.AppQty)>1){h=(parseInt(c.AppQty)-1).toString();i[u].getBindingContext().getModel().setProperty(y+"/AppQty",h);this._checkedTable.splice(D,1)}}}}}}}t.updateItems()}else if(!m){for(var u=0;u<i.length;u++){if(i[u].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){c=i[u].getBindingContext().getObject();y=i[u].getBindingContext().sPath;if(c.ParentMaterial===s&&c.RefItmNumber===n&&c.Material===o&&c.Serialno===g){h=c.PoQuan.toString();i[u].getBindingContext().getModel().setProperty(y+"/AppQty",h);t.updateItems();break}}}}this.checkReturnPossible()},onDialogDisplay:function(e,t,i,s,a){var o=this.getView();var r=sap.ui.getCore().byId("DialogID-dialog");var n=o.getElementBinding();var l=new sap.ui.model.json.JSONModel;var g=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZRETURN_CREA_SRV");var d=new sap.ui.model.Filter({path:"SalesDoc",operator:sap.ui.model.FilterOperator.EQ,value1:s});var h="/DocumentsChild(Invoice='"+e+"',MatAndQuan='"+t+"+"+i+"',SerialNums='"+a+"')/DocToItemChild";g.read(h,{filters:[d],success:function(e){l.setData(e);r.setBusy(false);r.setModel(l,"myModel");sap.ui.core.BusyIndicator.hide()},error:function(e){r.setBusy(false);console.log(e)}});r.setModel(l,"myModel");r.setBusyIndicatorDelay(100);r.setBusy(true);console.log(this.getView())},_configDialog:function(e){var t=!!e.data("multi");this._oDialog.setMultiSelect(t);var i=e.data("confirmButtonText");this._oDialog.setConfirmButtonText(i);var s=!!e.data("remember");this._oDialog.setRememberSelections(s);var a=!!e.data("showClearButton");this._oDialog.setShowClearButton(a);var o=e.data("growing");this._oDialog.setGrowing(o=="true");var r=e.data("threshold");if(r){this._oDialog.setGrowingThreshold(parseInt(r))}var n=e.data("draggable");this._oDialog.setDraggable(n=="true");var l=e.data("resizable");this._oDialog.setResizable(l=="true");var g="sapUiResponsivePadding--header sapUiResponsivePadding--subHeader sapUiResponsivePadding--content sapUiResponsivePadding--footer";var d=e.data("responsivePadding");if(d){this._oDialog.addStyleClass(g)}else{this._oDialog.removeStyleClass(g)}this._oDialog.getBinding("items").filter([]);syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialog)},onSearch:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("Material",h.Contains,t);var s=e.getParameter("itemsBinding");s.filter([i])},handleClose:function(e){var t=e.getParameter("selectedContexts");if(t&&t.length){this._markedTable=[];for(var i=0;i<t.length;i++){var s=t[i].sPath.split("/")[2];var a={Material:e.getParameters().selectedContexts[i].getModel().getData().results[s].Material,RefItmNumber:e.getParameters().selectedContexts[i].getModel().getData().results[s].RefItmNumber,ParentMaterial:e.getParameters().selectedContexts[i].getModel().getData().results[s].ParentMaterial,Serialno:this._justSelectedNS};this._markedTable.push(a);this._checkedTable.push(a)}this.markParentWindow()}},handleCloseCancel:function(e){this._justSelected.setSelected(false)},markParentWindow:function(){var e=this.byId("PROD_TBL"),t=e.getItems();var i;for(var s=0;s<t.length;s++){if(t[s].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var a=t[s].getBindingContext().getObject();var o=t[s].getBindingContext().sPath;for(var r=0;r<this._markedTable.length;r++){if(a.ParentMaterial===this._markedTable[r].ParentMaterial&&a.Material===this._markedTable[r].Material&&a.RefItmNumber===this._markedTable[r].RefItmNumber&&(a.Serialno===this._markedTable[r].Serialno||!this._markedTable[r].Serialno)){if(t[s].getSelected()===true){i=(parseInt(a.AppQty)+1).toString();t[s].getBindingContext().getModel().setProperty(o+"/AppQty",i)}else{t[s].setSelected(true);i="1";t[s].getBindingContext().getModel().setProperty(o+"/AppQty",i)}}}}}e.updateItems();this.checkReturnPossible()},onMessageButtonPressed:function(e){var t=e.getSource();if(!this._oMsgPopover){this._oMsgPopover=sap.ui.xmlfragment("cre.ret.app.view.MessagePopover",this.getView().getController());t.addDependent(this._oMsgPopover);$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oMsgPopover)}this._oMsgPopover.toggle(t)},onShopSelect:function(){try{this._oWorklistDialog=this.getRouter().getView("cre.ret.app.view.Worklist").getController()._oDialog}catch(e){}if(!this._oDialog&&!this._oWorklistDialog){this._oDialog=sap.ui.xmlfragment("cre.ret.app.view.SelectShop",this);this.getView().addDependent(this._oDialog)}this._oDialog=this._oDialog||this._oWorklistDialog;$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oDialog);this._oDialog.open()},onCloseSelectShop:function(){this._oDialog.close()},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this._oModel.metadataLoaded().then(function(){var e=this.getModel().createKey("Documents",{Invoice:t});this._bindView("/"+e)}.bind(this));this._checkedTable=[]},_bindView:function(e){var t=this.getModel("objectView"),i=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){i.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding(),i,s=[];if(this.oTemplate){i=this.oTemplate.clone()}else{i=new sap.ui.xmlfragment("cre.ret.app.view.LineItemTemplate",this)}if(!t.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}if(t.getBoundContext().getObject().InvoiceIsExt===true){if(t.getBoundContext().getObject().SerialNums){s.push(new sap.ui.model.Filter("Serialno",sap.ui.model.FilterOperator.EQ,t.getBoundContext().getObject().SerialNums))}}else if(t.getBoundContext().getObject().NoSapInvoice===true){s.push(new sap.ui.model.Filter("SalesDoc",sap.ui.model.FilterOperator.EQ,t.getBoundContext().getObject().SalesDoc))}else{s.push(new sap.ui.model.Filter("SalesDoc",sap.ui.model.FilterOperator.EQ,t.getBoundContext().getObject().SalesDoc))}var a=function(e){this._setCreateEnabled(e)}.bind(this);if(sap.ui.getCore().getMessageManager().getMessageModel().getData().length>0){sap.ui.getCore().getMessageManager().removeAllMessages()}this._oLineTable.bindItems({path:t.sPath+"/DocToItem",sorter:new sap.ui.model.Sorter("ItmNumber",true,true),filters:s,template:i});this._oLineTable._getSelectAllCheckbox().attachSelect(function(e){a(e.getSource().getParent())});this._oLineTable.attachUpdateFinished(function(e){if(e.getSource().getItems()[1]){var t=e.getSource().getItems()[1].getBindingContext().getObject(),i=this.formatter._setInitialCustomerData(t);this.getModel("customer").setData(i.getData())}this._setReturnStatus(e.getSource().getItems())}.bind(this));this._oViewModel.setProperty("/busy",false);this._oViewModel.setProperty("/returnAmount","0.00");this._oViewModel.setProperty("/isReturnable",t.getBoundContext().getObject().IsReturnable);if(!this._oViewModel.getProperty("/isReturnable")){if(t.getBoundContext().getObject().DocType==="ZIFS"){r.error(this.getResourceBundle().getText("unableReturnIFSblock"),{styleClass:this.getOwnerComponent().getContentDensityClass()})}else{r.error(this.getResourceBundle().getText("unableReturn2SOExists"),{styleClass:this.getOwnerComponent().getContentDensityClass()})}}if(!this.getModel("appView").getProperty("/Shop")){var o=this.getOwnerComponent().getModel("CheckOut");o.read("/UserDefaultsSet(Name='')",{success:function(e,t){this.getModel("appView").setProperty("/Shop",t.data.Shop)}.bind(this),error:function(e){}.bind(this)})}},_checkCustomerData:function(e){var t=this.getResourceBundle(),i=this.getView().getBindingContext().getObject();var s=function(e){r.error(e,{styleClass:this.getOwnerComponent().getContentDensityClass()})}.bind(this);i.DispMethod=i.IsDisposition?this._oViewModel.getProperty("/dispMethod"):"";var o=a._validateCustomerData(e,i,t);if(i.hasOwnProperty("DispMethod")){delete i.DispMethod}if(i.hasOwnProperty("OpenReturnDoc")){delete i.OpenReturnDoc}if(i.hasOwnProperty("ReturnStatus")){delete i.ReturnStatus}if(e.PostlCod1){if(!this._validateZipCode()){o.push(t.getText("PostCodeValidate"))}}var n=o.length;if(n>0){var l=this.getResourceBundle().getText("LACK_OF_CUST_DATA_"+n,o);s(l);return false}return true},_reasonChange:function(e){var t=e.getParameter("selectedItem"),i=this.getModel("addData"),s=t.getParent().getBindingContext().getPath(),a=t.getKey(),o=i.getProperty(s);if(!o){o={RetReason:a}}else{o.RetReason=a}e.getSource().setValueState(sap.ui.core.ValueState.None);i.setProperty(s,o);if(!i.getProperty(s)){i.setData({});i.setProperty(s,o)}},_handleSaveShop:function(e){var t=e.getSource().getParent().getContent()[0].getSelectedItem().getBindingContextPath(),i=this.getView().getModel("CheckOut"),s=i.getData(t);if(s.Selected!==true){s.Selected=true;i.update(t,s,{async:false,success:function(e,t){var i=t.headers.shop,s=t.headers.blocked==="X",a=this.getResourceBundle().getText("ShopSaved",[i]);if(s){this._handleBlockedShop()}else{this.getModel("appView").setProperty("/ShopAvailable",true);this.getModel("appView").setProperty("/Shop",i);sap.m.MessageToast.show(a)}}.bind(this),error:function(e){l.showODataError(e,this.getOwnerComponent())}.bind(this)})}this._oDialog.close()},_handleBlockedShop:function(){var e=this.getResourceBundle().getText("ShopBlocked");this.getModel("appView").setProperty("/ShopAvailable",false);this.getRouter().navTo("worklist",{},true);sap.m.MessageBox.error(e,{actions:[r.Action.CLOSE],onClose:function(){this.getRouter().navTo("worklist",{},true)}.bind(this)})},_setTableLinesUnenabled:function(e){var t=e.getItems();for(var i=0;i<t.length;i++){if(t[i].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var s=t[i].getBindingContext().getObject();if(s){if(s.ReturnDoc||s.ReturnNotAllowed===true){t[i]._oMultiSelectControl.setEnabled(false);e._getSelectAllCheckbox().setEnabled(false)}else if(s.ReturnNotAllowedZtad===true){t[i]._oMultiSelectControl.setEnabled(false);e._getSelectAllCheckbox().setEnabled(false)}else if(s.ParentMaterial){t[i]._oMultiSelectControl.setEnabled(false)}else{t[i]._oMultiSelectControl.setEnabled(true)}}}}},_setCreateEnabled:function(e,t){var i=e.getItems(),s=0,o=false,r,n;for(var l=0;l<i.length;l++){if(i[l].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){if(i[l].getSelected()===true){n=i[l].getBindingContext().getObject();if(!n.ParentMaterial){r=parseInt(i[l].getCells()[3].getValue(),10);s=parseFloat(s)+r*(parseFloat(n.BruttoValue)/parseFloat(n.AppQty))}if(!t){a._checkProductSet(i,n.Material,n.RefItmNumber)}o=true}}}if(o){this._oViewModel.setProperty("/createEnable",o);this._oViewModel.setProperty("/returnAmount",parseFloat(s));return}else{this._oViewModel.setProperty("/returnAmount",parseFloat(0));this._oViewModel.setProperty("/createEnable",o)}},_callCreateReturnFunction:function(){this.oHeaderData=this.aDocToItems=undefined;this._getSelectedData();var e=function(e){this._fnUpdateSuccess(e)}.bind(this);var t=function(e){this._fnEntityCreationFailed(e)}.bind(this);if(this.oHeaderData&&this.aDocToItems){var i=s._fillDeepData(this.oHeaderData,this.aDocToItems);if(i){this._oViewModel.setProperty("/busy",true);g.createReturn(i,e,t)}}},_getSelectedData:function(){var e=this._oLineTable.getSelectedItems(),t=this._oLineTable.getItems(),i=this._oAddTable.getItems();for(var s=0;s<e.length;s++){this._createEntity(e[s])}t.forEach(function(e){if(e.getBindingContext()&&e.getBindingContext().getObject().ReturnNotAllowedZtad===true){this._createEntity(e)}}.bind(this));if(i){for(s=0;s<i.length;s++){this._createEntity(i[s],"addData")}}},_createEntity:function(e,t){var i=e.getBindingContext(t).getObject(),s=e.getBindingContext(t).getPath(),a=this.getView().getBindingContext().getObject(),o=a.CustNum,r=a.Taxnumber1,n=a.InvoiceIsExt,l=this._oViewModel;if(!i.Serialno){if(parseInt(i.TargetQty,10)===1&&!e.getCells()[3].getEnabled()){}else{i.AppQty=parseFloat(this.formatter._formatTargetQuantity(e.getCells()[3].getValue())).toFixed(3)}}else{}i=this._fillDataFromAddModel(i,s);i.Werks=this.getModel("appView").getProperty("/Shop");i.Zlsch=g.setPaymentMethodForItem(l,i);i.RetReason=this.getModel("addData").getProperty("/RetReason");i=this._fillCustomerInfo(i);if(!this.oHeaderData){a.IsDisposition=l.getProperty("/disposition");a.Zlsch=a.IsDisposition?l.getProperty("/dispMethod"):l.getProperty("/zlsch");this.oHeaderData=a}if(!this.aDocToItems){this.aDocToItems=[]}this.aDocToItems.push(i);return true},_fillDataFromAddModel:function(e,t){var i=this.getModel("addData").getData();if(e.ReturnNotAllowedZtad===true){e.RetReason="";e.Zlsch="W"}else{if(!e.ParentMaterial){this.sRetReason=i.RetReason;this.sPmntMeth=i.Zlsch}e.RetReason=this.sRetReason;e.Zlsch=this.Zlsch}return e},_fillCustomerInfo:function(e){var t=this._customerData;if(t){var i=this.formatter.fillObject(e,t)}else{return e}return i},_changeQty:function(e){var t=e.getParameter("value");if(t){var i=parseInt(t,10),s=parseInt(e.getSource().getBindingContext().getObject().PoQuan,10),a=this._oLineTable.getSelectedItems();if(i!==0&&i<=s&&a.length>=1){e.getSource().getBindingContext().getObject().AppQty=i.toString();this.byId("PROD_TBL").updateItems();e.getSource().setValueState("None");this._setCreateEnabled(this._oLineTable);this._oViewModel.setProperty("/createEnable",true);return}else if(i<s&&a.length<1){e.getSource().getBindingContext().getObject().AppQty=i.toString();this.byId("PROD_TBL").updateItems();e.getSource().setValueState("None");this._oViewModel.setProperty("/createEnable",false);return}e.getSource().setValueState("Error");this._oViewModel.setProperty("/createEnable",false)}else{e.getSource().setValueState("Error");this._oViewModel.setProperty("/createEnable",false)}},_beforeNav:function(){this._oLineTable._getSelectAllCheckbox().setEnabled(true);this._oLineTable.removeSelections();this.oTemplate=this._oLineTable.getBindingInfo("items").template;this._oViewModel.setProperty("/createEnable",false);this._oViewModel.setProperty("/addReturnAmount",s._calculateAddPrice(this._oAddTable.getItems()));this.getModel("customer").setData({});this.getModel("addData").setData({});this._oViewModel.setProperty("/addItems",0)},onExit:function(){this._oLineTable.removeSelections()},_callCreateCustomerData:function(){var e=this.getView(),t=this._oLineTable.getItems()[1].getBindingContext().getObject(),i=this.formatter._setInitialCustomerData(t);this._oViewModel.setProperty("/bussinessClient",t.Taxnumber1?true:false);if(!this._oCustDialog){this._oCustDialog=sap.ui.xmlfragment(e.getId(),"cre.ret.app.view.AddCustomer",e.getController());this._oCustDialog.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.addDependent(this._oCustDialog);$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oCustDialog)}this._oCustDialog.attachEventOnce("afterOpen",function(){if(!this.getModel("customer").getData()){this.getModel("customer").setData(i.getData())}this._validateSubmitEnablement()}.bind(this));if(this.getView().getBindingContext().getObject().InvoiceIsExt===true){this._oViewModel.setProperty("/enableSubmit",false);this._oViewModel.setProperty("/requiredData",sap.ui.core.ValueState.Warning)}else{this._oViewModel.setProperty("/enableSubmit",true);this._oViewModel.setProperty("/requiredData",sap.ui.core.ValueState.None)}this._oCustDialog.open()},_selectItemFromScaner:function(e){var t=this._oLineTable.getItems(),i=e.getParameter("value"),s=this.getOwnerComponent().getContentDensityClass();this._justSelectedNS=i;for(var a=0;a<t.length;a++){if(t[a].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var o=t[a].getBindingContext().getObject(),r=o.Serialno,n=o.ReturnDoc,l=o.ReturnNotAllowed;if(r&&r.trim!==""){if(r===i.trim()){if(n||l){sap.m.MessageBox.warning(this.getResourceBundle().getText("SCAN_UNABLE"),{styleClass:s});e.getSource().setValue();return}t[a].setSelected(true);this._justSelected=t[a];var g=false;for(var a=0;a<t.length;a++){if(t[a].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var d=t[a].getBindingContext().getObject();if(d.ParentMaterial===o.Material&&d.RefItmNumber===o.RefItmNumber){var g=true;break}}}for(var a=0;a<t.length;a++){if(t[a].getMetadata().getElementName()!=="sap.m.GroupHeaderListItem"){var d=t[a].getBindingContext().getObject();if(d.ParentMaterial===o.Material&&d.RefItmNumber===o.RefItmNumber){if(o.Serialno){for(var h=0;h<this._checkedTable.length;h++){if(d.ParentMaterial===this._checkedTable[h].ParentMaterial&&d.Material===this._checkedTable[h].Material&&d.RefItmNumber===this._checkedTable[h].RefItmNumber&&o.Serialno===this._checkedTable[h].Serialno){if(parseInt(d.AppQty)===1){d.AppQty=0;t[a].setSelected(false);this._checkedTable.splice(h,1)}else if(parseInt(d.AppQty)>1){d.AppQty=(parseInt(d.AppQty)-1).toString();this._checkedTable.splice(h,1)}}}}}}}var u=this.byId("PROD_TBL");u.updateItems();if(g===true){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("cre.ret.app.view.Dialog",this);this.getView().addDependent(this._oDialog);$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oDialog)}this.onDialogDisplay(o.Invoice,o.Material,o.RefItmNumber,o.SalesDoc,o.Serialno);this._oDialog.open();if(document.querySelector("#DialogID-ok-content")){var c=this.getView().getModel("i18n").getResourceBundle().getText("confirmButton");document.querySelector("#DialogID-ok-content").textContent=c;$("#DialogID-ok-content").css("font-size","10px")}}e.getSource().setValue();return}}}}sap.m.MessageBox.warning(this.getResourceBundle().getText("PROD_UNABLE",[i]),{styleClass:s});e.getSource().setValue()},_validateSubmitEnablement:function(){var e=this.formatter._getFromFields(this.byId("customerData")),t=this._oViewModel;if(this.getView().getBindingContext().getObject().InvoiceIsExt===true){e[8].required=true;e[7].required=true}var i;for(var s=0;s<e.length;s++){i=e[s].control;if(e[s].required){var a=i.getValue();if(!a){t.setProperty("/enableSubmit",false);return}}}this._checkForErrorMessages(t);this._checkDispositionPrint(t)},_checkForErrorMessages:function(e){var t=this._oBinding.oModel.oData;if(t.length>0){var i=true;for(var s=0;s<t.length;s++){if(t[s].type==="Error"&&!t[s].technical){i=false;break}}e.setProperty("/enableSubmit",i)}else{e.setProperty("/enableSubmit",true)}},_checkDispositionPrint:function(e){if(e.getProperty("/disposition")){e.setProperty("/enableSubmit",e.getProperty("/dispoPrint"))}else{e.setProperty("/enableSubmit",true)}},_validateZipCode:function(){var e=this.formatter._getFromFields(this.byId("customerData")),t=e[7].control,i=t._oTempValue._aContent,s=t._oTempValue._aInitial,a=/^\d+$/;var o=i.every(function(e,t){if(t!==2&&!a.test(e)){return false}return true},this);return o},_countryHelpRequest:function(e){var t=e.getSource();if(!this._oCountryDialog){this._oCountryDialog=sap.ui.xmlfragment("cre.ret.app.view.Country",this);this._oCountryDialog.setModel(this.getView().getModel());$.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oCountryDialog)}this._oCountryDialog.getBinding("items").filter([]);this._oCountryDialog.attachEventOnce("confirm",function(e){var i=e.getParameter("selectedItem").getDescription();t.setValue(i)});this._oCountryDialog.open()},_handleCountrySearch:function(e){var t=e.getParameter("value"),i=[],s;if(t){s=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();i.push(new sap.ui.model.Filter("Landx",sap.ui.model.FilterOperator.StartsWith,s))}var a=e.getSource().getBinding("items");a.filter(i)},_fnUpdateSuccess:function(e){var t=this.getResourceBundle(),i=t.getText("close"),s=t.getText("return"),a=t.getText("EmptySuccessMsg");if(e.data.hasOwnProperty("RtrnToMsg")&&e.data.RtrnToMsg.results!==undefined&&e.data.RtrnToMsg.results.length>0){var n=e.data.RtrnToMsg.results[0].hasOwnProperty("ReturnDoc")?e.data.RtrnToMsg.results[0].ReturnDoc:"",l=e.data.RtrnToMsg.results[0].hasOwnProperty("Znos")?e.data.RtrnToMsg.results[0].Znos:"",g=e.data.RtrnToMsg.results[0].hasOwnProperty("Znus")?e.data.RtrnToMsg.results[0].Znus:"";if(l){a=t.getText("SCS_RT_MSG_NOTE",[n,l])}else if(g){a=t.getText("SCS_RT_MSG_NOTE_ZNUS",[n,g])}else{a=t.getText("SCS_RT_MSG",[n])}if(e.data.RtrnToMsg.results[0].hasOwnProperty("LongText")){a=a+" "+e.data.RtrnToMsg.results[0].LongText}}if(e.data.hasOwnProperty("DocToBapi")&&e.data.DocToBapi.results!==undefined&&e.data.DocToBapi.results.length>0){o._addMessageFromData(e.data.DocToBapi.results)}r.success(a,{id:"successReturnMessageBox",styleClass:this.getOwnerComponent().getContentDensityClass(),actions:[i],onClose:function(e){if(e===i){this.cleanup();this.getRouter().navTo("worklist",{},true);window.location.reload()}}.bind(this)});this._finishAction();this._beforeNav()},_fnEntityCreationFailed:function(e){l.showODataError(e,this.getOwnerComponent());this._finishAction()},_finishAction:function(){this._oViewModel.setProperty("/busy",false);this._oViewModel.setProperty("/createEnable",false);if(this._oCustDialog.isOpen()){this._oCustDialog.close()}this.aDocToItems=[];this.oHeaderData=null},_setReturnStatus:function(e){var t=0,i=0,s=0,a=this.getView().getBindingContext().getObject();e.forEach(function(e){var a=e.getBindingContext().getObject();if((a.ReturnDoc||a.ReturnNotAllowed===true)&&!a.ReturnNotAllowedMatnr){t++}else if(a.NsStatus==="DOST"){i++}else if(a.ReturnDocOld){s++}});var o=0;if(t===0){o=u}else if(a.ReturnStatus===0){o=f}else{o=a.ReturnStatus}if(o===u){if(i){o=_}else if(s){o=P}}this._oViewModel.setProperty("/returnStatus",this.getResourceBundle().getText(`DOCUMENT_STATUS${o}`));this._oViewModel.setProperty("/returnStatusState",o===u||o===p?"Success":o===f||o===c||o===_||o===P?"Warning":"Error")},cleanup:function(){this._oViewModel=g.creeateObjectViewModel(false);this.setModel(this._oViewModel,"objectView");this.oAddSNInput=null;this.snAddPath="";this.instQuan="";this.Invoice="";this.ItmNumber="";this.Zzbillacc="";this._markedTable=[];this._checkedTable=[];this._justSelected="";this._justSelectedNS=""}})});
//mati222
//# sourceMappingURL=Object.controller.js.map